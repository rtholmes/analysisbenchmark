<project name="SimpleAnalysisBenchmark" default="dist" basedir=".">
	<description>
        Benchmark program for testing static analyses. Adapted from Martin Robillard's JayFXBenchmark.
    </description>

	<!-- Main Locations -->
	<!-- src: 				the source files comprising the sample code -->
	<!-- src.test: 			tests that simulate the src code executing (for dynamic analyses) -->
	<!-- eval: 				code for building a model of a static or dynamic analysis -->
	<!-- eval.test: 		code for validating the model of the static or dynamic analysis against what we would expect to be generated from src -->

	<!-- Main Tasks -->
	<!-- clean: 			removes any temporary resources -->
	<!-- compile: 			compiles the src, srcTest, eval, evalTest code -->
	<!-- jar: 				creates a jar of the compiled src code and copies it to depfind_uw -->
	<!-- static: 			runs the static analysis on the code generated from src -->
	<!-- validateStatic:	compares the results of the static analysis to a known oracle -->

	<!-- Main Task TODO -->
	<!-- dynamic:			runs the dynamic analysis using the tests generated from src.test -->
	<!-- validateDynamic:	compares the results of the dynamic analysis to a known oracle -->

	<property name="maxmemory" value="1024m" />
	
	<property name="sample" location="sample" />
	<property name="build" location="build" />

	<!-- sample code / tests for running sample code (for dynamic analyses) -->
	<property name="sample" location="${sample}/src" />
	<property name="sample.test" location="${sample}/test" />

	<!-- eval code / tests for analysis validation -->
	<property name="validation" location="validation" />
	<property name="validation.test" location="${validation}/test" />

	<!-- build directories -->
	<property name="build.sample" location="${build}/sample" />
	<property name="build.sample.test" location="${build}/sampleTest" />
	<property name="build.validation.test" location="${build}/validationTest" />

	<property name="dist" location="dist" />
	<property name="lib" location="lib" />

	<property name="jarFile" location="${dist}/AnalysisBenchmark.jar" />

	<property name="report" location="report" />
	<property name="report.staticAnalysis" location="${report}/static" />
	<property name="report.dynamicAnalysis" location="${report}/dynamic" />
	<property name="report.srcTest" location="${report}/srcTest" />
	<property name="report.evalTest" location="${report}/evalTest" />

	<path id="classpath.sample">
		<!-- create classpath -->
		<fileset dir="${lib}">
			<include name="*.jar" />
		</fileset>
		<pathelement path="${build.sample}" />
		<pathelement path="${build.sample.test}" />
	</path>

	<path id="classpath.validation">
		<!-- create classpath -->
		<fileset dir="${lib}">
			<include name="*.jar" />
		</fileset>
		<pathelement path="${build.validation.test}" />
	</path>

	<path id="classpath.src.trace">
		<path refid="classpath.src" />
		<!-- rth: for dynamic -->
		<dirset dir="${lsmr.base}/bin" />
		<dirset dir="${dynamicTracer.home}/bin" />
		<fileset refid="lsmr.lib" />
		<fileset refid="dynamicTracer.lib" />
		<!-- end rth -->
	</path>

	<target name="init">
		<!-- Create the time stamp -->
		<tstamp />
		<!-- Create the build directory structure used by compile -->
		<mkdir dir="${build}" />
		<mkdir dir="${build.sample}" />
		<mkdir dir="${build.sample.test}" />
		<mkdir dir="${build.validation.test}" />
		<mkdir dir="${report.staticAnalysis}" />
		<mkdir dir="${report.dynamicAnalysis}" />
		<mkdir dir="${report.srcTest}" />
		<mkdir dir="${report.evalTest}" />
	</target>

	<target name="clean" description="clean up">
		<delete dir="${build}" />
		<delete dir="${dist}" />
		<!-- stop deleting the reports all the time -->
		<!-- <delete dir="${report}" /> -->
	</target>


	<target name="compile" depends="compile.sample,compile.validation" description="compile the source" />

	<target name="compile.sample" depends="init" description="compile the source">
		<!-- Compile the java code from ${src} into ${build} -->
		<javac srcdir="${sample}" destdir="${build.sample}" includeantruntime="false" classpathref="classpath.sample" />
		<javac srcdir="${sample.test}" destdir="${build.sample.test}" includeantruntime="false" classpathref="classpath.sample" />
	</target>

	<target name="compile.validation" depends="init" description="compile the source">
		<!-- Compile the java code from ${src} into ${build} -->
		<javac srcdir="${validation.test}" destdir="${build.validation.test}" includeantruntime="false" classpathref="classpath.validation" />
	</target>

	<target name="jar" depends="compile" description="Packages JAR file and copies to depfind_uw for testing">
		<jar jarfile="${jarFile}">
			<zipfileset dir="${build.src}" prefix="" includes="**/*.class" />
		</jar>
		<copy file="${jarFile}" tofile="${depfindDir}/input.jar" overwrite="yes" />
	</target>

	<target name="dist" depends="compile" description="generate the distribution">
		<!-- Create the distribution directory -->
		<mkdir dir="${dist}/lib" />

		<!-- Put everything in ${build} into the AnalysisBenchmark-${DSTAMP}.jar file -->
		<jar jarfile="${dist}/lib/AnalysisBenchamark-${DSTAMP}.jar" basedir="${build.src}" />
	</target>

	<target name="test.sample" depends="compile.sample" description="perform tests">
		<junit maxmemory="${maxmemory}" printsummary="yes" haltonfailure="no" fork="yes" forkmode="once">
			<!--<jvmarg value="-Djava.compiler=NONE"/>-->

			<classpath refid="classpath.src" />

			<formatter type="plain" />
			
			<batchtest todir="${report.srcTest}">
				<fileset dir="${src.test}">
					<include name="**/*.java" />
				</fileset>
			</batchtest>
		</junit>
	</target>

	<target name="dynamic" depends="compile.sample" description="perform tests">
		<junit maxmemory="${maxmemory}" printsummary="yes" haltonfailure="no" fork="yes" forkmode="once">
			<!--<jvmarg value="-Djava.compiler=NONE"/>-->

			<classpath refid="classpath.src.trace" />

			<formatter type="plain" />

			<batchtest todir="${report.srcTest}">
				<fileset dir="${src.test}">
					<include name="**/*.java" />
				</fileset>
			</batchtest>
		</junit>
	</target>

	<target name="validateStatic" depends="static" description="Validate static analyses">
		<junit maxmemory="${maxmemory}" printsummary="yes" haltonfailure="yes" fork="yes" forkmode="once">
			<!--<jvmarg value="-Djava.compiler=NONE"/>-->
			<classpath refid="classpath.eval" />

			<formatter type="plain" />

			<batchtest todir="${report.evalTest}">
				<fileset dir="${eval.test}">
					<include name="**/*.java" />
				</fileset>
			</batchtest>
		</junit>
	</target>


	<target name="static" depends="compile" description="perform static analyses">
		<!-- BUG: for unknown reasons 'ant clean; ant static' fails; some environmental thing isn't being set up quite right -->
		<dependencyextractor destfile="${report.staticAnalysis}/static-${DSTAMP}_${TSTAMP}.xml" xml="yes" minimize="yes">
			<path>
				<!-- <pathelement location="."/> -->
				<pathelement location="${build.src}" />
			</path>
		</dependencyextractor>

		<!-- make a copy of the latest extraction for easier reference -->
		<copy file="${report.staticAnalysis}/static-${DSTAMP}_${TSTAMP}.xml" tofile="${report.staticAnalysis}/static_latest.xml" />

		<!-- configure an HTML version of the report -->
		<!-- The stylesheet doesn't work with the UW XML format <xslt style="${dependencyfinder.home}/etc/DependencyGraphToHTML.xsl" in="${report.staticAnalysis}/static-${DSTAMP}_${TSTAMP}.xml" out="${report.staticAnalysis}/static-${DSTAMP}_${TSTAMP}.html" /> -->
		<!-- The stylesheet doesn't work with the UW XML format <copy file="${dependencyfinder.home}/etc/dependency.style.css" tofile="${report.staticAnalysis}/dependency.style.css" overwrite="no" /> -->
		<!-- The stylesheet doesn't work with the UW XML format <copy file="${report.staticAnalysis}/static-${DSTAMP}_${TSTAMP}.html" tofile="${report.staticAnalysis}/static_latest.html" /> -->
	</target>
	<!-- End DependencyFinder -->
</project>